{% extends "base.html" %}

{% block title %}Reportes y Estadísticas{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Reportes y Estadísticas</h2>
        {% if current_user.rol == RoleEnum.ADMIN %}
        <a href="{{ url_for('exportar_reportes', formato='excel') }}" class="btn btn-success">
            Exportar Reportes (Excel)
        </a>
        <a href="{{ url_for('exportar_reportes', formato='json') }}" class="btn btn-success">
            Exportar Reportes (JSON)
        </a>
        <a href="{{ url_for('exportar_reportes', formato='csv') }}" class="btn btn-success">
            Exportar Reportes (CSV)
        </a>
        <a href="{{ url_for('exportar_reportes', formato='pdf') }}" class="btn btn-success">
            Exportar Reportes (PDF)
        </a>
        {% endif %}
    </div>

    {% if current_user.rol in [RoleEnum.ADMIN, RoleEnum.PROFESOR] %}
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <h5 class="card-title">Total Productos</h5>
                    <h2>{{ stats.total_productos }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h5 class="card-title">Productos Disponibles</h5>
                    <h2>{{ productos_disponibles }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <h5 class="card-title">Productos Prestados</h5>
                    <h2>{{ productos_prestados }}</h2>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-danger" role="alert">
        No tienes permiso para ver esta sección.
    </div>
    {% endif %}
    
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Distribución de Estados</h5>
                    <canvas id="estadosChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Movimientos por Día</h5>
                    <canvas id="movimientosChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Fecha Inicio</label>
                    <input type="date" name="fecha_inicio" class="form-control" value="{{ fecha_inicio }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Fecha Fin</label>
                    <input type="date" name="fecha_fin" class="form-control" value="{{ fecha_fin }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Estado</label>
                    <select name="estado" class="form-control">
                        <option value="todos">Todos</option>
                        {% for estado in estados %}
                        <option value="{{ estado.nombre }}" {% if estado_filter == estado.nombre %}selected{% endif %}>
                            {{ estado.nombre }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary">Filtrar</button>
                </div>
            </form>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Actividad por Usuario</h5>
                    <canvas id="usuariosChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="dropdown">
        <button class="btn btn-success dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="fas fa-file-export"></i> Exportar
        </button>
        <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="{{ url_for('exportar_reportes', formato='csv') }}">CSV</a></li>
            <li><a class="dropdown-item" href="{{ url_for('exportar_reportes', formato='excel') }}">Excel</a></li>
            <li><a class="dropdown-item" href="{{ url_for('exportar_reportes', formato='json') }}">JSON</a></li>
            <li><a class="dropdown-item" href="{{ url_for('exportar_reportes', formato='pdf') }}">PDF</a></li>
        </ul>
    </div>

    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Tendencias de Uso</h5>
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Tiempo Promedio de Préstamo</h5>
                    <canvas id="tiempoPrestamoChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Productos más Solicitados</h5>
                    <canvas id="productosPopularesChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <h3>Productos Más Solicitados</h3>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Total Movimientos</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for producto, total in productos_frecuentes %}
                        <tr>
                            <td>{{ producto.nombre }}</td>
                            <td>{{ total }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="col-md-6">
            <h3>Últimos Movimientos</h3>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Producto</th>
                            <th>Usuario</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for movimiento in ultimos_movimientos %}
                        <tr>
                            <td>{{ movimiento.fecha_hora.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>{{ movimiento.producto.nombre }}</td>
                            <td>{{ movimiento.usuario.nombre_usuario }}</td>
                            <td>{{ movimiento.estado_nuevo }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Estados Chart
    const ctxEstados = document.getElementById('estadosChart').getContext('2d');
    new Chart(ctxEstados, {
        type: 'pie',
        data: {
            labels: ['Disponibles', 'Prestados'],
            datasets: [{
                data: [{{ productos_disponibles }}, {{ productos_prestados }}],
                backgroundColor: ['#28a745', '#ffc107']
            }]
        }
    });

    // Movimientos Chart
    const ctxMovimientos = document.getElementById('movimientosChart').getContext('2d');
    new Chart(ctxMovimientos, {
        type: 'bar',
        data: {
            labels: ['Lun', 'Mar', 'Mie', 'Jue', 'Vie'],
            datasets: [{
                label: 'Movimientos',
                data: [12, 19, 3, 5, 2],
                backgroundColor: '#007bff'
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Add user activity chart
    const ctxUsuarios = document.getElementById('usuariosChart').getContext('2d');
    new Chart(ctxUsuarios, {
        type: 'bar',
        data: {
            labels: {{ movimientos_por_usuario|map(attribute=0)|list|tojson }},
            datasets: [{
                label: 'Movimientos',
                data: {{ movimientos_por_usuario|map(attribute=1)|list|tojson }},
                backgroundColor: '#17a2b8'
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Add trend analysis chart
    const ctxTrend = document.getElementById('trendChart').getContext('2d');
    new Chart(ctxTrend, {
        type: 'line',
        data: {
            labels: {{ movimientos_por_dia|map(attribute=0)|list|tojson }},
            datasets: [{
                label: 'Movimientos Diarios',
                data: {{ movimientos_por_dia|map(attribute=1)|list|tojson }},
                borderColor: '#007bff',
                tension: 0.1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Add time analysis chart
    const ctxTiempoPrestamo = document.getElementById('tiempoPrestamoChart').getContext('2d');
    new Chart(ctxTiempoPrestamo, {
        type: 'bar',
        data: {
            labels: {{ productos_frecuentes|map(attribute='nombre')|list|tojson }},
            datasets: [{
                label: 'Días promedio',
                data: {{ tiempo_prestamo_promedio|tojson }},
                backgroundColor: '#20c997'
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Días'
                    }
                }
            }
        }
    });

    // Add popular products chart
    const ctxProductosPopulares = document.getElementById('productosPopularesChart').getContext('2d');
    new Chart(ctxProductosPopulares, {
        type: 'doughnut',
        data: {
            labels: {{ productos_populares|map(attribute='nombre')|list|tojson }},
            datasets: [{
                data: {{ productos_populares|map(attribute='total')|list|tojson }},
                backgroundColor: ['#007bff', '#28a745', '#17a2b8', '#ffc107', '#dc3545']
            }]
        }
    });
</script>
{% endblock %}
